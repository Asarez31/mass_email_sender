<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Email Campaign - AsarezMail</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col">
  <div class="relative flex h-auto min-h-screen w-full flex-col overflow-x-hidden">
    <div class="layout-container flex h-full grow flex-col">
      <!-- Header -->
      <header class="flex items-center justify-between border-b border-solid border-b-[#f0f2f4] px-10 py-3">
        <div class="flex items-center gap-4 text-[var(--primary-color)]">
          <div class="size-20">
            <a href="/"><img src="{{ url_for('static', filename='img/logo2.png') }}" alt="Mail Icon"
              class="h-20 w-20 text-[var(--primary-color)]" /></a>
          </div>
        </div>
        <div class="flex items-center gap-4">
          <a class="text-sm font-medium hover:text-[var(--primary-color)]" href="\">Home</a>
          <a class="text-sm font-medium hover:text-[var(--primary-color)]" href="\settings">Settings</a>
        </div>
      </header>

      <!-- Main Content -->
      <main class="flex-grow p-6 flex justify-center">
        <div class="bg-white shadow-md rounded-lg p-6 w-full max-w-3xl">
          <h2 class="text-2xl font-semibold text-gray-800 mb-4">
            Create Campaign
          </h2>

          <!-- Subject -->
          <div class="mb-4">
            <label class="block text-gray-700 font-medium">Subject</label>
            <input id="subject" type="text" class="w-full p-2 border rounded mt-1" placeholder="Enter email subject" />
          </div>

          <!-- Email Body -->
          <div class="mb-4">
            <label class="block text-gray-700 font-medium">Email Body</label>
            <textarea id="body" rows="6" class="w-full p-2 border rounded mt-1"
              placeholder="Write your message. Use {placeholder} for personalization."></textarea>
          </div>

          <!-- File Upload -->
          <div class="mb-4">
            <label class="block text-gray-700 font-medium">Upload Recipients (CSV/XLSX)</label>
            <input id="fileUpload" type="file" accept=".csv, .xlsx" class="w-full p-2 border rounded mt-1 bg-gray-50" />
          </div>

          <!-- Recipients -->
          <div class="mb-4">
            <h3 class="text-gray-700 font-medium">
              Recipients (<span id="recipientCount">0</span>)
            </h3>
          </div>

          <!-- Action -->
          <div class="flex justify-end">
            <button id="nextBtn" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
              Next â†’
            </button>
          </div>
        </div>
    </div>
  </div>
  </main>

  <!-- JS -->
  <script>
    const nextBtn = document.getElementById("nextBtn");
    const fileInput = document.getElementById("fileUpload");
    const recipientCountEl = document.getElementById("recipientCount");

    let recipients = [];
    let campaignData = {};

    async function loadCampaign() {
      try {
        const res = await fetch("/api/get_campaign");
        campaignData = await res.json();

        subject.value = campaignData.subject || "";
        body.value = campaignData.body || "";

      } catch (err) {
        console.error("Failed to load campaign", err);
      }
    }

    // Handle file upload dynamically
    fileInput.addEventListener("change", async () => {
      const file = fileInput.files[0];
      if (!file) return;

      const formData = new FormData();
      formData.append("file", file);

      try {
        const response = await fetch("/api/upload_recipients", {
          method: "POST",
          body: formData,
        });
        const data = await response.json();

        if (data.success) {
          recipients = data.recipients;
          recipientCountEl.textContent = data.count;

        } else {
          alert(data.message);
        }
      } catch (err) {
        console.error(err);
        alert("Failed to upload recipients");
      }
    });

    // Save campaign
    nextBtn.addEventListener("click", async () => {
      const subject = document.getElementById("subject").value.trim();
      const body = document.getElementById("body").value.trim();
      if (!subject || !body) {
        alert("Please enter subject and body");
        return;
      }

      if (recipients.length === 0) {
        alert("Please upload a recipient file");
        return;
      }

      try {
        const response = await fetch("/api/save_campaign", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ subject, body, recipients }),
        });

        const data = await response.json();
        if (data.success) {
          window.location.href = "/review";
        } else {
          alert(data.message);
        }
      } catch (err) {
        console.error(err);
        alert("Failed to save campaign");
      }
    });

    // Load campaign on page load
    loadCampaign();
  </script>
</body>

</html>