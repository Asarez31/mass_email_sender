<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Review & Send - AsarezMail</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col">
  <!-- Header -->
  <header class="flex items-center justify-between border-b border-solid border-b-[#f0f2f4] px-10 py-3">
    <div class="flex items-center gap-4 text-[var(--primary-color)]">
      <div class="size-20">
        <a href="/"><img src="{{ url_for('static', filename='img/logo2.png') }}" alt="Mail Icon"
          class="h-20 w-20 text-[var(--primary-color)]" /></a>
      </div>
    </div>
    <div class="flex items-center gap-4">
      <a class="text-sm font-medium hover:text-[var(--primary-color)]" href="\">Home</a>
      <a class="text-sm font-medium hover:text-[var(--primary-color)]" href="\settings">Settings</a>
    </div>
  </header>

  <!-- Main -->
  <main class="flex-grow p-6 flex justify-center">
    <div class="bg-white shadow-md rounded-lg p-6 w-full max-w-3xl">
      <h2 class="text-2xl font-semibold text-gray-800 mb-4">Review Campaign</h2>

      <!-- Subject -->
      <div class="mb-4">
        <h3 class="text-gray-700 font-medium">Subject</h3>
        <p id="reviewSubject" class="mt-1 p-2 border rounded bg-gray-50 text-gray-800"></p>
      </div>

      <!-- Email Body -->
      <div class="mb-4">
        <h3 class="text-gray-700 font-medium">Email Body</h3>
        <div id="reviewBody" class="mt-1 p-4 border rounded bg-gray-50 text-gray-700 whitespace-pre-line"></div>
      </div>

      <!-- Recipients -->
      <div class="mb-4">
        <h3 class="text-gray-700 font-medium">
          Recipients (<span id="recipientCount">0</span>)
        </h3>
        <div id="recipientList" class="mt-2 border rounded bg-gray-50 max-h-40 overflow-y-auto"></div>
      </div>

      <!-- Actions -->
      <div class="flex justify-between mt-6">
        <button id="backBtn" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
          ‚Üê Back / Edit Campaign
        </button>
        <button id="sendBtnBottom" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
          Send Email
        </button>
      </div>
    </div>
  </main>

  <!-- Popup -->
  <div id="popup" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded shadow-md text-center max-w-sm">
      <svg class="w-12 h-12 text-green-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M9 12l2 2l4-4m6 2a9 9 0 11-18 0a9 9 0 0118 0z" />
      </svg>
      <h3 class="text-lg font-semibold text-gray-800">Email Sent Successfully!</h3>
      <button id="closePopup" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Great!</button>
    </div>
  </div>

  <!-- JS -->
  <script>
    const recipientList = document.getElementById("recipientList");
    const recipientCount = document.getElementById("recipientCount");
    const popup = document.getElementById("popup");
    const closePopup = document.getElementById("closePopup");
    const backBtn = document.getElementById("backBtn");
    const reviewSubject = document.getElementById("reviewSubject");
    const reviewBody = document.getElementById("reviewBody");
    const sendBtn = document.getElementById("sendBtnBottom");

    let campaignData = {};

    async function loadCampaign() {
      try {
        const res = await fetch("/api/get_campaign");
        campaignData = await res.json();

        reviewSubject.textContent = campaignData.subject || "";
        reviewBody.textContent = campaignData.body || "";

        renderRecipients();
      } catch (err) {
        console.error("Failed to load campaign", err);
      }
    }

    function renderRecipients() {
      recipientList.innerHTML = "";
      if (!campaignData.recipients) return;

      campaignData.recipients.forEach((r, idx) => {
        const div = document.createElement("div");
        div.className = "flex justify-between items-center p-2 border-b text-gray-700";
        div.innerHTML = `<span>${r.Name || r.name || "No Name"} - ${r.Email || r.email || "No Email"}</span>`;
        recipientList.appendChild(div);
      });

      recipientCount.textContent = campaignData.recipients.length;
    }

    // Send campaign
    sendBtn.addEventListener("click", async () => {
      try {
        const res = await fetch("/api/send_email", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ mode: "campaign" }),
        });

        const data = await res.json();
        if (res.ok) {
          popup.classList.remove("hidden");
          alert(data.message);
        } else {
          alert(data.error);
        }
      } catch (err) {
        alert("Failed to send campaign");
        console.error(err);
      }
    });

    // Popup close
    closePopup.addEventListener("click", () => popup.classList.add("hidden"));
    popup.addEventListener("click", (e) => { if (e.target === popup) popup.classList.add("hidden"); });

    // Back
    backBtn.addEventListener("click", () => {
      window.location.href = "/";
    });

    // Load campaign on page load
    loadCampaign();
  </script>
</body>

</html>