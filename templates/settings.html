<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>AsarezMail - Provider Settings</title>
  <link crossorigin href="https://fonts.gstatic.com/" rel="preconnect" />
  <link as="style"
    href="https://fonts.googleapis.com/css2?display=swap&family=Inter:wght@400;500;700;900&family=Noto+Sans:wght@400;500;700;900"
    onload="this.rel='stylesheet'" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64," />
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

  <style type="text/tailwindcss">
    :root {
        --primary-color: #137fec;
        --secondary-color: #f0f2f4;
        --background-color: #ffffff;
        --text-primary-color: #111418;
        --text-secondary-color: #617589;
      }
      .radio-button:checked {
        border-color: var(--primary-color);
        background-image: url("data:image/svg+xml,%3csvg viewBox=%270 0 16 16%27 fill=%27%23137fec%27 xmlns=%27http://www.w3.org/2000/svg%27%3e%3ccircle cx=%278%27 cy=%278%27 r=%273%27/%3e%3c/svg%3e");
      }
    </style>
</head>

<body class="bg-[var(--background-color)]" style="font-family: Inter, 'Noto Sans', sans-serif">
  <div class="relative flex h-auto min-h-screen w-full flex-col overflow-x-hidden">
    <div class="layout-container flex h-full grow flex-col">
      <!-- Header -->
      <header class="flex items-center justify-between border-b border-solid border-b-[#f0f2f4] px-10 py-3">
        <div class="flex items-center gap-4 text-[var(--primary-color)]">
          <div class="size-20">
            <img src="{{ url_for('static', filename='img/logo2.png') }}" alt="Mail Icon" class="h-20 w-20 text-[var(--primary-color)]" />
          </div>
        </div>
        <div class="flex items-center gap-4">
          <a class="text-sm font-medium hover:text-[var(--primary-color)]" href="\">Home</a>
          <a class="text-sm font-medium hover:text-[var(--primary-color)]" href="#">Campaigns</a>
          <a class="text-sm font-medium hover:text-[var(--primary-color)]" href=".\templates\settings.html">Settings</a>
        </div>
      </header>

      <!-- Main -->
      <div class="flex flex-1 justify-center py-10 px-4 sm:px-6 lg:px-8">
        <div class="w-full max-w-xl space-y-8">
          <!-- Title -->
          <div>
            <h1 class="text-3xl font-bold tracking-tight text-[var(--text-primary-color)]">
              Email Provider Settings
            </h1>
            <p class="mt-2 text-sm text-[var(--text-secondary-color)]">
              Configure your email provider to send emails through AsarezMail.
            </p>
          </div>

          <!-- Provider Selection -->
          <div class="space-y-6">
            <h3 class="text-lg font-bold text-[var(--text-primary-color)]">
              Choose your email provider
            </h3>
            <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
              <label
                class="flex items-center gap-4 rounded-md border p-4 cursor-pointer has-[:checked]:border-[var(--primary-color)] has-[:checked]:ring-2 has-[:checked]:ring-[var(--primary-color)]">
                <input checked class="radio-button h-5 w-5 border-2 border-[#dbe0e6]" name="email_provider" type="radio"
                  value="gmail" />
                <p class="text-sm font-medium text-[var(--text-primary-color)]">
                  Gmail
                </p>
              </label>
              <label
                class="flex items-center gap-4 rounded-md border p-4 cursor-pointer has-[:checked]:border-[var(--primary-color)] has-[:checked]:ring-2 has-[:checked]:ring-[var(--primary-color)]">
                <input class="radio-button h-5 w-5 border-2 border-[#dbe0e6]" name="email_provider" type="radio"
                  value="outlook" />
                <p class="text-sm font-medium text-[var(--text-primary-color)]">
                  Outlook
                </p>
              </label>
              <label
                class="flex items-center gap-4 rounded-md border p-4 cursor-pointer has-[:checked]:border-[var(--primary-color)] has-[:checked]:ring-2 has-[:checked]:ring-[var(--primary-color)]">
                <input class="radio-button h-5 w-5 border-2 border-[#dbe0e6]" name="email_provider" type="radio"
                  value="smtp" />
                <p class="text-sm font-medium text-[var(--text-primary-color)]">
                  Custom SMTP
                </p>
              </label>
            </div>
          </div>

          <!-- Settings Panels -->
          <div class="space-y-6 rounded-md border border-gray-200 p-6">
            <!-- Gmail -->
            <div class="space-y-4" data-provider="gmail">
              <h3 class="text-lg font-bold text-[var(--text-primary-color)]">
                Gmail Settings
              </h3>
              <div>
                <label class="block text-sm font-medium" for="gmail_api_key">Gmail Email</label>
                <input class="form-input mt-1 w-full rounded-md border px-3 py-2" id="gmail_email"
                  placeholder="Enter your Gmail Address" />
              </div>
              <div>
                <label class="block text-sm font-medium" for="gmail_api_key">API Key</label>
                <input class="form-input mt-1 w-full rounded-md border px-3 py-2" id="gmail_api_key"
                  placeholder="Enter your Gmail API key" />
              </div>
            </div>

            <!-- Outlook -->
            <div class="space-y-4" data-provider="outlook" style="display: none">
              <h3 class="text-lg font-bold text-[var(--text-primary-color)]">
                Outlook Settings
              </h3>
              <div>
                <label class="block text-sm font-medium" for="outlook_client_id">Client ID</label>
                <input class="form-input mt-1 w-full rounded-md border px-3 py-2" id="outlook_client_id"
                  placeholder="Enter your Outlook Client ID" />
              </div>
              <div>
                <label class="block text-sm font-medium" for="outlook_client_secret">Client Secret</label>
                <input class="form-input mt-1 w-full rounded-md border px-3 py-2" id="outlook_client_secret"
                  type="password" placeholder="Enter your Outlook Client Secret" />
              </div>
            </div>

            <!-- SMTP -->
            <div class="space-y-4" data-provider="smtp" style="display: none">
              <h3 class="text-lg font-bold text-[var(--text-primary-color)]">
                Custom SMTP Settings
              </h3>
              <div class="grid sm:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium" for="smtp_host">SMTP Host</label>
                  <input class="form-input mt-1 w-full rounded-md border px-3 py-2" id="smtp_host"
                    placeholder="Enter SMTP host" />
                </div>
                <div>
                  <label class="block text-sm font-medium" for="smtp_port">SMTP Port</label>
                  <input class="form-input mt-1 w-full rounded-md border px-3 py-2" id="smtp_port"
                    placeholder="Enter SMTP port" />
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium" for="smtp_username">Username</label>
                <input class="form-input mt-1 w-full rounded-md border px-3 py-2" id="smtp_username"
                  placeholder="Enter SMTP username" />
              </div>
              <div>
                <label class="block text-sm font-medium" for="smtp_password">Password</label>
                <input class="form-input mt-1 w-full rounded-md border px-3 py-2" id="smtp_password" type="password"
                  placeholder="Enter SMTP password" />
              </div>
            </div>
          </div>

          <!-- Default Email -->
          <div class="space-y-4 rounded-md border border-gray-200 p-6">
            <h3 class="text-lg font-bold text-[var(--text-primary-color)]">
              Default Test Email
            </h3>
            <div>
              <label class="block text-sm font-medium" for="test_email">Email Address</label>
              <input class="form-input mt-1 w-full rounded-md border px-3 py-2" id="test_email" type="email"
                placeholder="Enter default test email" />
            </div>
          </div>

          <!-- Save -->
          <div class="flex justify-between pt-4">
            <button id="testEmailBtn" class="rounded-md bg-gray-100 px-4 h-10 text-sm font-bold hover:bg-gray-200">
              Send Test Email
            </button>
            <button id="saveBtn"
              class="rounded-md bg-[var(--primary-color)] px-4 h-10 text-sm font-bold text-white hover:bg-blue-600">
              Save Settings
            </button>
          </div>
          <!-- Status Message -->
          <p id="statusMessage" class="mt-3 text-sm text-gray-600"></p>
        </div>
      </div>
    </div>
  </div>

  <script>
    const providerRadios = document.querySelectorAll(
      'input[name="email_provider"]'
    );
    const providerSettings = {
      gmail: document.querySelector('[data-provider="gmail"]'),
      outlook: document.querySelector('[data-provider="outlook"]'),
      smtp: document.querySelector('[data-provider="smtp"]'),
    };

    function toggleProviderSettings() {
      const selected = document.querySelector(
        'input[name="email_provider"]:checked'
      ).value;
      Object.values(providerSettings).forEach(
        (s) => (s.style.display = "none")
      );
      providerSettings[selected].style.display = "block";
    }

    providerRadios.forEach((radio) =>
      radio.addEventListener("change", toggleProviderSettings)
    );
    toggleProviderSettings();

    // Load saved settings on page load
    async function loadSettings() {
      try {
        const res = await fetch("/api/settings/provider");
        if (!res.ok) return;
        const data = await res.json();

        // Select provider
        if (data.provider) {
          document.querySelector(
            `input[value="${data.provider}"]`
          ).checked = true;
          toggleProviderSettings();
        }

        // Credentials (per provider)
        if (data.credentials) {
          if (data.credentials.gmail_email)
            document.getElementById("gmail_email").value =
              data.credentials.gmail_email;
          if (data.credentials.api_key)
            document.getElementById("gmail_api_key").value =
              data.credentials.api_key;
          if (data.credentials.client_id)
            document.getElementById("outlook_client_id").value =
              data.credentials.client_id;
          if (data.credentials.client_secret)
            document.getElementById("outlook_client_secret").value =
              data.credentials.client_secret;
          if (data.credentials.smtp_host)
            document.getElementById("smtp_host").value =
              data.credentials.smtp_host;
          if (data.credentials.smtp_port)
            document.getElementById("smtp_port").value =
              data.credentials.smtp_port;
          if (data.credentials.smtp_username)
            document.getElementById("smtp_username").value =
              data.credentials.smtp_username;
          if (data.credentials.smtp_password)
            document.getElementById("smtp_password").value =
              data.credentials.smtp_password;
        }

        // Default email
        if (data.default_email)
          document.getElementById("test_email").value = data.default_email;
      } catch (err) {
        console.error("Error loading settings:", err);
      }
    }

    // Save settings
    async function saveSettings() {
      const selected = document.querySelector(
        'input[name="email_provider"]:checked'
      ).value;
      const credentials = {};
      const statusMessage = document.getElementById("statusMessage");

      if (selected === "gmail") {
        credentials.gmail_email = document
          .getElementById("gmail_email")
          .value.trim();
        credentials.api_key = document
          .getElementById("gmail_api_key")
          .value.trim();

        if (!credentials.api_key || !credentials.gmail_email) {
          statusMessage.textContent = "⚠️ Please enter an required details.";
          statusMessage.classList.add("text-red-500");
          return;
        }
      } else if (selected === "outlook") {
        credentials.client_id = document
          .getElementById("outlook_client_id")
          .value.trim();
        credentials.client_secret = document
          .getElementById("outlook_client_secret")
          .value.trim();

        if (!credentials.client_id || !credentials.client_secret) {
          statusMessage.textContent =
            "⚠️ Please enter a Client ID and Client Secret.";
          statusMessage.classList.add("text-red-500");
          return;
        }
      } else if (selected === "smtp") {
        credentials.smtp_host = document
          .getElementById("smtp_host")
          .value.trim();
        credentials.smtp_port = document
          .getElementById("smtp_port")
          .value.trim();
        credentials.smtp_username = document
          .getElementById("smtp_username")
          .value.trim();
        credentials.smtp_password = document
          .getElementById("smtp_password")
          .value.trim();

        if (
          !credentials.smtp_host ||
          !credentials.smtp_port ||
          !credentials.smtp_username ||
          !credentials.smtp_password
        ) {
          statusMessage.textContent =
            "⚠️ Please provide all the necessary information.";
          statusMessage.classList.add("text-red-500");
          return;
        }
      }

      const default_email = document
        .getElementById("test_email")
        .value.trim();
      if (!default_email) {
        statusMessage.textContent = "⚠️ Please provide a default test email.";
        statusMessage.classList.add("text-red-500");
        return;
      }

      const body = {
        provider: selected,
        credentials: credentials,
        default_email: document.getElementById("test_email").value,
      };

      const res = await fetch("/api/settings/provider", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });

      const data = await res.json();
      if (res.ok) {
        alert(data.message || "✅ API key saved successfully!");
        statusMessage.classList.remove("text-red-500");
        statusMessage.hidden = true;
        /*statusMessage.textContent = "✅ API key saved successfully!";
        statusMessage.classList.add("text-green-600");*/
      } else {
        alert(data.error || "❌ Error saving settings");
      }
    }

    document
      .getElementById("testEmailBtn").addEventListener("click", async () => {
        try {
          const res = await fetch("/api/send_test_email", {
            method: "POST",
          });
          const data = await res.json();
          if (res.ok) {
            alert(data.message || "✅ Test email sent!");
          } else {
            alert(data.error || "❌ Failed to send test email.");
          }
        } catch (err) {
          console.error("Error sending test email:", err);
          alert("❌ Error communicating with server.");
        }
      });

    // Attach save button
    document
      .getElementById("saveBtn")
      .addEventListener("click", saveSettings);

    // Auto load settings on page load
    loadSettings();
  </script>
</body>

</html>